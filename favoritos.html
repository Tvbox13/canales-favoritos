<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DC TV - Categor√≠as</title>
  <!-- Ya no usaremos Clappr, puedes remover este script si quieres -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script> -->
  <style>
    :root {
      --text-color: #fff;
      --focus-outline: 3px solid gold;
      --bg-overlay: rgba(0, 0, 0, 0.7);
      --canal-bg: rgba(0, 0, 0, 0.65);
      --canal-border: gold;
      --transition-time: 0.3s;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('https://dl.dropboxusercontent.com/scl/fi/53cl5dg07jneprsqbvkdp/Fondo-dorado-negro.jpg?rlkey=fxysssw9toe3zdhw873nob0k7&st=brpgsbw8&dl=0') no-repeat center center fixed;
      background-size: cover;
      color: var(--text-color);
      text-align: center;
      position: relative;
      overflow-y: auto;
      user-select: none;
      outline: none;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: var(--bg-overlay);
      z-index: 0;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px 15px 70px;
      position: relative;
      z-index: 1;
      outline-offset: 2px;
    }

    h1 {
      font-size: 4rem;
      margin: 50px 0 30px;
      background: linear-gradient(90deg, gold 0%, white 40%, black 80%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.85);
      user-select: text;
    }

    h2 {
      font-size: 2.4rem;
      margin: 32px 0 15px;
      cursor: pointer;
      color: gold;
      text-shadow: 1px 1px 5px black;
      border-bottom: 3px solid var(--canal-border);
      padding-bottom: 8px;
      transition: border-color var(--transition-time);
      outline-offset: 5px;
      user-select: none;
    }

    h2:focus {
      outline: var(--focus-outline);
      border-color: white;
    }

    #buscador {
      padding: 14px 20px;
      font-size: 22px;
      width: 90%;
      max-width: 620px;
      margin: 25px auto 40px;
      border-radius: 14px;
      border: none;
      outline: none;
      background-color: rgba(255, 255, 255, 0.18);
      color: white;
      text-align: center;
      box-shadow: 0 0 16px gold;
      transition: box-shadow 0.3s, background-color 0.3s;
      font-weight: 600;
      user-select: text;
    }

    #buscador::placeholder {
      color: #ddd;
      font-style: italic;
    }

    #buscador:focus {
      outline: var(--focus-outline);
      box-shadow: 0 0 28px white;
      background-color: rgba(255, 255, 255, 0.25);
    }

    .canales-container {
      display: none;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 25px;
      max-height: 500px;
      overflow-y: auto;
      outline: none;
      padding-right: 8px; /* espacio para scrollbar */
    }

    .canal {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-radius: 15px;
      border: 3px solid var(--canal-border);
      background-color: var(--canal-bg);
      font-size: 1.5rem;
      font-weight: 700;
      color: gold;
      cursor: pointer;
      user-select: none;
      transition: transform var(--transition-time), box-shadow var(--transition-time);
      outline-offset: 6px;
      text-align: left;
    }

    .canal:hover,
    .canal:focus-visible {
      box-shadow: 0 0 18px gold;
      transform: scale(1.03);
      outline: var(--focus-outline);
      background-color: rgba(30, 30, 30, 0.75);
    }

    .canal img {
      width: 36px;
      height: 27px;
      object-fit: contain;
      background-color: black;
      border-radius: 10px;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 0 6px rgba(255, 215, 0, 0.7);
      user-select: none;
    }

    .canal span {
      flex: 1;
      user-select: text;
    }

    #player-wrapper {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 12px;
      flex-direction: column;
    }

    #player {
      width: 100%;
      height: 100%;
      max-width: 1000px;
      max-height: 90vh;
      box-shadow: 0 0 30px gold;
      border-radius: 12px;
      background: black;
      position: relative;
    }

    .close-player-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      background: transparent;
      border: none;
      color: gold;
      font-size: 2.8rem;
      cursor: pointer;
      outline-offset: 4px;
      font-weight: bold;
      transition: color 0.2s;
      z-index: 10000;
      user-select: none;
    }

    .close-player-btn:hover,
    .close-player-btn:focus-visible {
      color: white;
      outline: var(--focus-outline);
    }

    /* Scrollbar para canales */
    .canales-container::-webkit-scrollbar {
      width: 8px;
    }
    .canales-container::-webkit-scrollbar-thumb {
      background-color: gold;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 3rem;
      }
      h2 {
        font-size: 1.8rem;
      }
      #buscador {
        font-size: 18px;
        padding: 12px 18px;
        max-width: 100%;
      }
      .canal {
        font-size: 1.2rem;
        flex-wrap: wrap;
        height: auto;
        padding: 10px 12px;
        gap: 6px;
      }
      .canal img {
        width: 70px;
        height: 52px;
        margin-right: 12px;
      }
      #player {
        max-width: 100%;
        max-height: 70vh;
      }
    }
  </style>
</head>
<body tabindex="0" aria-label="P√°gina de canales de DC TV">
  <div class="container" tabindex="-1">
    <h1>DC TV</h1>
    <input type="search" id="buscador" aria-label="Buscar canal" placeholder="üîç Buscar canal..." autocomplete="off" />
    <div id="categorias" aria-live="polite" aria-relevant="additions"></div>
  </div>

  <div id="player-wrapper" role="dialog" aria-modal="true" aria-labelledby="player-title" tabindex="-1" aria-hidden="true" >
    <button class="close-player-btn" aria-label="Cerrar reproductor" title="Cerrar reproductor">&times;</button>
    <div id="player" tabindex="0" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <!-- VLC.js library -->
  <script src="https://cdn.jsdelivr.net/npm/@vlc/web@latest/dist/vlc.min.js"></script>

  <script>
    const OWNER = "Tvbox13";
    const REPO = "canales-favoritos";

    const archivosM3U = [
      { nombre: "Categor√≠a 1", archivo: "lista.m3u" },
      { nombre: "Categor√≠a 2", archivo: "lista 2.m3u" },
      { nombre: "Categor√≠a 3", archivo: "lista3.m3u" },
      { nombre: "Categor√≠a 4", archivo: "lista 2.m3u" }
    ];

    const categoriasContainer = document.getElementById("categorias");
    const buscador = document.getElementById("buscador");
    const playerWrapper = document.getElementById("player-wrapper");
    const playerElement = document.getElementById("player");
    const closePlayerBtn = playerWrapper.querySelector(".close-player-btn");
    let playerInstance = null; // VLC.js player instance
    let lastFocusedCanal = null;

    // Enfocar el primer canal visible dentro del contenedor
    function focusFirstCanal(container) {
      const primerCanalVisible = Array.from(container.querySelectorAll(".canal"))
        .find(canal => canal.offsetParent !== null);
      if (primerCanalVisible) {
        primerCanalVisible.focus();
      } else {
        container.previousElementSibling.focus();
      }
    }

    // Crear categor√≠as y sus eventos
    archivosM3U.forEach((item, index) => {
      const urlArchivo = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${encodeURIComponent(item.archivo)}`;

      const categoriaDiv = document.createElement("div");
      categoriaDiv.className = "categoria";

      const titulo = document.createElement("h2");
      titulo.textContent = item.nombre;
      titulo.tabIndex = 0;
      titulo.setAttribute("role", "button");
      titulo.setAttribute("aria-expanded", "false");
      titulo.setAttribute("aria-controls", `categoria-${index}`);

      titulo.addEventListener("click", () => toggleCategoria(index, urlArchivo));
      titulo.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " " || e.key === "Spacebar") {
          e.preventDefault();
          toggleCategoria(index, urlArchivo);
        }
      });

      const canalesDiv = document.createElement("div");
      canalesDiv.className = "canales-container";
      canalesDiv.id = `categoria-${index}`;
      canalesDiv.setAttribute("role", "region");
      canalesDiv.setAttribute("aria-label", `Lista de canales de ${item.nombre}`);
      canalesDiv.tabIndex = -1;

      categoriaDiv.appendChild(titulo);
      categoriaDiv.appendChild(canalesDiv);
      categoriasContainer.appendChild(categoriaDiv);
    });

    // Mostrar u ocultar categor√≠as con carga din√°mica
    async function toggleCategoria(index, url) {
      const div = document.getElementById(`categoria-${index}`);
      const titulo = div.previousElementSibling;
      const isVisible = div.style.display === "flex";

      // Cerrar todas las categor√≠as y limpiar b√∫squeda al abrir una
      document.querySelectorAll(".canales-container").forEach(d => {
        d.style.display = "none";
        d.previousElementSibling.setAttribute("aria-expanded", "false");
      });
      buscador.value = "";

      if (!isVisible) {
        div.innerHTML = "";
        div.style.display = "flex";
        titulo.setAttribute("aria-expanded", "true");
        await cargarListaM3U(url, div);
        focusFirstCanal(div);
      }
    }

    // Carga y parseo de archivo M3U
    async function cargarListaM3U(m3uUrl, container) {
      try {
        const resp = await fetch(m3uUrl);
        if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);
        const texto = await resp.text();

        const lines = texto.split(/\r?\n/);
        let canalesAgregados = 0;

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("#EXTINF")) {
            const info = lines[i];
            const nombre = info.split(",")[1]?.trim() || "Canal";
            const logoMatch = info.match(/tvg-logo="([^"]+)"/);
            const logo = logoMatch ? logoMatch[1].trim() : "";
            const url = (lines[i + 1] || "").trim();

            if (url && (url.startsWith("http") || url.startsWith("https"))) {
              agregarCanal(nombre, url, logo, container);
              canalesAgregados++;
            }
          }
        }

        if (canalesAgregados === 0) {
          container.innerHTML = `<p style="color: #f0a500; font-weight:600;">No se encontraron canales v√°lidos en esta lista.</p>`;
        }
      } catch(err) {
        console.error("Error cargando M3U:", err);
        container.innerHTML = `<p style="color: #ff4c4c; font-weight: 700;">No se pudo cargar la lista de canales.</p>`;
      }
    }

    // Agregar canal a la lista
    function agregarCanal(nombre, url, logo, container) {
      const canalBtn = document.createElement("button");
      canalBtn.className = "canal";
      canalBtn.setAttribute("data-nombre", nombre.toLowerCase());
      canalBtn.setAttribute("aria-label", `Reproducir canal ${nombre}`);
      canalBtn.type = "button";
      canalBtn.tabIndex = 0;

      canalBtn.addEventListener("click", () => reproducir(url, canalBtn));
      canalBtn.addEventListener("keydown", e => { if (e.key === "Enter" || e.key === " ") canalBtn.click(); });

      if (logo) {
        const img = document.createElement("img");
        img.src = logo;
        img.alt = `${nombre} logo`;
        img.loading = "lazy";
        canalBtn.appendChild(img);
      }

      const nombreSpan = document.createElement("span");
      nombreSpan.textContent = nombre;
      canalBtn.appendChild(nombreSpan);

      container.appendChild(canalBtn);
    }

    // Reproducci√≥n usando VLC.js
    async function reproducir(url, canalBoton) {
      lastFocusedCanal = canalBoton;
      if (playerInstance) {
        try {
          await playerInstance.unload();
        } catch {}
        playerInstance = null;
      }
      playerElement.innerHTML = ""; // Limpia contenido previo

      playerWrapper.style.display = "flex";
      playerWrapper.setAttribute("aria-hidden", "false");
      playerWrapper.focus();
      document.body.style.overflow = "hidden";

      try {
        playerInstance = await VLC.create(playerElement, {
          media: url,
          autoplay: true,
          volume: 100,
          width: "100%",
          height: "100%",
          controls: true
        });
      } catch (error) {
        alert("Error al cargar el reproductor VLC.js para este canal.");
        console.error(error);
        cerrarPlayer();
      }
    }

    // Cerrar reproductor
    function cerrarPlayer() {
      if (playerInstance) {
        try {
          playerInstance.unload();
        } catch {}
        playerInstance = null;
      }
      playerWrapper.style.display = "none";
      playerWrapper.setAttribute("aria-hidden", "true");
      playerElement.innerHTML = "";
      document.body.style.overflow = "auto";

      if (lastFocusedCanal) {
        lastFocusedCanal.focus();
        lastFocusedCanal = null;
      } else {
        buscador.focus();
      }
    }

    closePlayerBtn.addEventListener("click", cerrarPlayer);

    document.addEventListener("keydown", e => {
      if ((e.key === "Escape" || e.key === "Backspace") && playerWrapper.style.display === "flex") {
        e.preventDefault();
        cerrarPlayer();
      }
    });

    // B√∫squeda con filtrado en categor√≠as abiertas
    buscador.addEventListener("input", () => {
      const filtro = buscador.value.trim().toLowerCase();

      if (!filtro) {
        // Restaurar todas las categor√≠as cerradas
        document.querySelectorAll(".canales-container").forEach(container => {
          container.style.display = "none";
          container.previousElementSibling.setAttribute("aria-expanded", "false");
          Array.from(container.children).forEach(canal => (canal.style.display = "flex"));
        });
        return;
      }

      // Mostrar todas las categor√≠as y filtrar canales
      document.querySelectorAll(".canales-container").forEach(container => {
        container.style.display = "flex";
        container.previousElementSibling.setAttribute("aria-expanded", "true");

        let hasVisibleCanal = false;
        Array.from(container.children).forEach(canal => {
          const nombre = canal.getAttribute("data-nombre");
          if (nombre && nombre.includes(filtro)) {
            canal.style.display = "flex";
            hasVisibleCanal = true;
          } else {
            canal.style.display = "none";
          }
        });

        // Si no hay canales visibles, ocultar categor√≠a entera
        if (!hasVisibleCanal) {
          container.style.display = "none";
          container.previousElementSibling.setAttribute("aria-expanded", "false");
        }
      });
    });

    // Inicializar foco en el primer t√≠tulo al cargar la p√°gina
    window.addEventListener("load", () => {
      const primerTitulo = document.querySelector("#categorias h2");
      if (primerTitulo) primerTitulo.focus();
    });

  </script>
</body>
</html>
