<script>
  // Configura aquí tus listas .m3u desde tu repo
  const GITHUB_BASE = "https://raw.githubusercontent.com/Tvbox13/canales-favoritos/main/";

  const listas = [
    { nombre: "Entretenimiento", archivo: "lista.m3u" },
    { nombre: "Deportes", archivo: "deportes.m3u" },
    { nombre: "Películas", archivo: "peliculas.m3u" },
    { nombre: "Infantiles", archivo: "infantiles.m3u" },
    { nombre: "Noticias", archivo: "noticias.m3u" }
  ];

  const categoriasContainer = document.getElementById("categorias");
  const buscador = document.getElementById("buscador");
  const playerWrapper = document.getElementById("player-wrapper");
  let playerInstance = null;
  const esAndroid = /Android/i.test(navigator.userAgent);

  listas.forEach((lista, index) => {
    const categoriaDiv = document.createElement("div");
    categoriaDiv.className = "categoria";

    const titulo = document.createElement("h2");
    titulo.textContent = lista.nombre;
    titulo.tabIndex = 0;
    titulo.onclick = () => toggleCategoria(index, GITHUB_BASE + lista.archivo);
    titulo.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") titulo.click();
    };

    const canalesDiv = document.createElement("div");
    canalesDiv.className = "canales-container";
    canalesDiv.id = `categoria-${index}`;

    categoriaDiv.appendChild(titulo);
    categoriaDiv.appendChild(canalesDiv);
    categoriasContainer.appendChild(categoriaDiv);
  });

  function toggleCategoria(index, url) {
    const div = document.getElementById(`categoria-${index}`);
    const isVisible = div.style.display === "flex";

    document.querySelectorAll(".canales-container").forEach(d => d.style.display = "none");

    if (!isVisible) {
      div.innerHTML = "";
      div.style.display = "flex";
      cargarListaM3U(url, div);
    }
  }

  function cargarListaM3U(m3uUrl, container) {
    fetch(m3uUrl)
      .then(response => response.text())
      .then(data => {
        const lines = data.split('\n');
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("#EXTINF")) {
            const nombre = lines[i].split(',')[1]?.trim() || "Canal";
            const logoMatch = lines[i].match(/tvg-logo="([^"]+)"/);
            const logo = logoMatch ? logoMatch[1] : "";
            const url = lines[i + 1]?.trim();

            if (url && url.startsWith("http")) {
              agregarCanal(nombre, url, logo, container);
            }
          }
        }
      })
      .catch(error => console.error("Error cargando M3U:", error));
  }

  function agregarCanal(nombre, url, logo, container) {
    const canal = esAndroid ? document.createElement("a") : document.createElement("button");
    canal.className = "canal";
    canal.setAttribute("data-nombre", nombre.toLowerCase());

    if (esAndroid) {
      const intentUrl = `intent://${url.replace(/^https?:\/\//, '')}#Intent;package=org.videolan.vlc;type=video/*;scheme=http;end`;
      canal.href = intentUrl;
      canal.target = "_self";
    } else {
      canal.onclick = () => reproducir(url);
    }

    if (logo) {
      const img = document.createElement("img");
      img.src = logo;
      img.alt = nombre;
      canal.appendChild(img);
    }

    const span = document.createElement("span");
    span.textContent = nombre;
    canal.appendChild(span);
    container.appendChild(canal);
  }

  function reproducir(url) {
    if (playerInstance) {
      playerInstance.destroy();
    }
    playerWrapper.style.display = "block";
    playerInstance = new Clappr.Player({
      source: url,
      parentId: "#player",
      autoPlay: true,
      height: "100%",
      width: "100%",
    });
  }

  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" || e.key === "Backspace") {
      if (playerWrapper.style.display === "block") {
        playerWrapper.style.display = "none";
        if (playerInstance) {
          playerInstance.destroy();
          playerInstance = null;
        }
      }
    }
  });

  buscador.addEventListener("input", function () {
    const filtro = this.value.toLowerCase();
    const canales = document.querySelectorAll(".canal");
    canales.forEach(canal => {
      const nombre = canal.getAttribute("data-nombre");
      canal.style.display = nombre.includes(filtro) ? "flex" : "none";
    });
  });
</script>
